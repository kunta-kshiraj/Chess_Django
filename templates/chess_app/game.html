<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Game</title>
    {% load static %}
    {% include "bootstrap.html" %}
    <script src="{% static 'chessboard.js' %}"></script>
    <link rel="stylesheet" href="{% static 'chessboard.css' %}?v=1.02"/>
</head>
<body>
    {% include "navigation.html" %}
    
    <h4 class="text-center">Your Ongoing Game with {{ opponent.username }}</h4>
    
    <!-- Display opponent and player information -->
    <p id="current-turn-display" class="text-center {% if request.user == current_player %}text-success{% else %}text-warning{% endif %}">
        {% if request.user == current_player %}
            It is currently your turn.
        {% else %}
            Waiting for opponent's move...
        {% endif %}
    </p>

    <!-- Chess Board Display -->
    <table id="t1" border=1 align="center" class="chessboard">
        {% for row in chessboard %}
        <tr class="chess_row">
            <th class="chess_rank">{{ forloop.revcounter }}</th>
            {% for name, value in row.items %}
            <td class="chess_cell" id="{{ name }}">
                {% if value == "&nbsp;" %}
                    &nbsp;
                {% else %}
                    {% autoescape off %}
                    {% if value.isupper %}
                        <span class="white-piece">{{ value }}</span>
                    {% else %}
                        <span class="black-piece">{{ value }}</span>
                    {% endif %}
                    {% endautoescape %}
                {% endif %}
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
        <tr>
            <th></th>
            <th class="chess_file">a</th>
            <th class="chess_file">b</th>
            <th class="chess_file">c</th>
            <th class="chess_file">d</th>
            <th class="chess_file">e</th>
            <th class="chess_file">f</th>
            <th class="chess_file">g</th>
            <th class="chess_file">h</th>
        </tr>
    </table>
    
    <p class="text-center">You are playing as: <strong>{{ player_color }}</strong></p>

    <!-- Move Form -->
    <div class="text-center mt-3">
        <form id="move_form">
            <div id="move_input_group" {% if request.user != current_player %}style="display: none;"{% endif %}>
                <input type="text" id="move_position" placeholder="Enter e2e4" class="form-control d-inline-block w-auto">
                <button type="button" id="move_button" class="btn btn-primary">Move</button>
            </div>
        </form>
        <button type="button" id="resign_button" class="btn btn-danger mt-2">Resign</button>
    </div>

    <script>
        const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const gameId = "{{ game.id }}"; // Game ID from the backend
        const currentUserId = "{{ request.user.id }}"; // Current user ID as a string
        const gameSocket = new WebSocket(`${protocol}${window.location.host}/ws/game/${gameId}/`);
    
        // WebSocket connection open handler
        gameSocket.onopen = function () {
            console.log("WebSocket connection established.");
        };
    
        // WebSocket message handler
        gameSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);

    if (data.type === "game_update") {
        console.log("Game update received:", data);

        const board = data.board;

        // Update each cell on the chessboard
        for (const rank in board) {
            for (const file in board[rank]) {
                const cellId = file; // File corresponds to cell ID
                const cell = document.getElementById(cellId);
                const piece = board[rank][file];
                cell.innerHTML = piece === "&nbsp;" ? "&nbsp;" : piece; // Update piece
            }
        }

        // Update current turn display
        const currentUserId = "{{ request.user.id }}";
        const currentTurnDisplay = document.getElementById("current-turn-display");
        currentTurnDisplay.textContent =
            parseInt(data.current_turn) === parseInt(currentUserId)
                ? "It is currently your turn."
                : "Waiting for opponent's move...";
    } else if (data.type === "game_over") {
        alert(`Game over! Winner: ${data.winner}`);
        window.location.href = `/game_result/${gameId}/`;
    } else if (data.error) {
        alert(data.error);
    }
};

    
        // WebSocket connection close handler
        gameSocket.onclose = function () {
            console.log("WebSocket connection closed.");
        };
    
        // Move button click handler
        document.getElementById("move_button").addEventListener("click", function () {
            const moveInput = document.getElementById("move_position").value.trim();
            if (moveInput) {
                console.log(`Sending move: ${moveInput}`);
                gameSocket.send(JSON.stringify({ action: "move", move: moveInput }));
                document.getElementById("move_position").value = "";
            } else {
                alert("Please enter a valid move.");
            }
        });

    
        // Resign button click handler
        document.getElementById("resign_button").addEventListener("click", function () {
            if (confirm("Are you sure you want to resign?")) {
                // Send resign action via WebSocket
                gameSocket.send(JSON.stringify({ action: "resign" }));
                console.log("Resignation sent.");
            }
        });
    </script>
    
</body>
</html>
