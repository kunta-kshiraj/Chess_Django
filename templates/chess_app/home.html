<!-- home.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... existing head content ... -->
    {% load static %}
    {% include "bootstrap.html" %}
    <link rel="stylesheet" href="{% static 'chessboard.css' %}?v=1.01"/>
    <script src="{% static 'chessboard.js' %}"></script>
    <script>
        const csrftoken = '{{ csrf_token }}';
        const currentUserId = "{{ current_user_id }}";  // Passed from the view
    </script>
</head>
<body>
    {% include "navigation.html" %} <!-- Navigation bar -->

    {% if ongoing_game %}
        <!-- Chessboard Section: Display when there is an ongoing game -->
        <div class="chess-container table-responsive">
            <table class="chessboard">
                <tbody>
                    <!-- Chessboard Rows -->
                    {% for row_num, row in board.items %}
                    <tr>
                        <th>{{ row_num }}</th>  <!-- Display row number -->
                        {% for square in row %}
                        <td class="chess-square">{{ square|safe }}</td>  <!-- Render square (piece or empty) -->
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
                <!-- Chessboard columns (a-h) -->
                <tr>
                    <th></th>
                    <th>a</th>
                    <th>b</th>
                    <th>c</th>
                    <th>d</th>
                    <th>e</th>
                    <th>f</th>
                    <th>g</th>
                    <th>h</th>
                </tr>
            </table>
        </div>

        <!-- Move Form (if ongoing game exists) -->
        <form method="POST">
            {% csrf_token %}
            <div class="container mt-4">
                <div class="row justify-content-center">
                    <!-- Move Position Input -->
                    <div class="col-auto">
                        <div class="input-group">
                            <span class="input-group-text">Move (e.g., e2e4)</span>
                            {{ form.move_position }}
                        </div>
                        <div class="text-danger">{{ form.move_position.errors }}</div>  <!-- Error handling for move_position -->
                    </div>
            
                    <!-- Buttons -->
                    <div class="col-auto">
                        <button type="submit" name="move" class="btn btn-primary">Move</button>
                        <button type="submit" name="reset" class="btn btn-secondary">Reset</button>
                    </div>
                </div>
            </div>
            

            <!-- Message Display -->
            {% if error_message %}
            <div class="alert alert-danger mt-4">{{ error_message }}</div>
            {% elif success_message %}
            <div class="alert alert-success mt-4">{{ success_message }}</div>
            {% endif %}
        </form>
    {% else %}
        <!-- Challenge System Section -->
        <div class="container mt-5">
            <div class="row">
                <!-- Column for challenging other players -->
                <div class="col-md-6">
                    <h3>Challenge Other Players</h3>
                    <ul class="list-group user-list">
                        {% for user in active_users %}
                        <li class="list-group-item d-flex justify-content-between align-items-center" data-user-id="{{ user.id }}">
                            <span>{{ user.username }}</span>
                            <div>
                                {% if user.id in challenged_user_ids %}
                                    <!-- You have sent a challenge to this user -->
                                    <span class="badge badge-warning">Pending</span>
                                {% elif user.id in challengers_list %}
                                    <!-- This user has challenged you -->
                                    <button
                                        class="btn btn-success btn-sm ml-2 accept-btn"
                                        data-user-id="{{ user.id }}"
                                        data-action="accept"
                                    >Accept</button>
                                    <button
                                        class="btn btn-danger btn-sm ml-2 reject-btn"
                                        data-user-id="{{ user.id }}"
                                        data-action="reject"
                                    >Reject</button>
                                {% else %}
                                    <!-- No challenge between users -->
                                    <button class="btn btn-primary btn-sm challenge-btn" data-user-id="{{ user.id }}">Challenge</button>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <!-- Column for game history -->
                <div class="col-md-6">
                    <h3>Your Game History</h3>
                    {% if completed_games %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Opponent</th>
                                <th>Moves</th>
                                <th>Result</th>
                                <th>Journal Entry</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for game in completed_games %}
                            <tr>
                                <td>
                                    {% if game.player1 == request.user %}
                                        {{ game.player2.username }}
                                    {% else %}
                                        {{ game.player1.username }}
                                    {% endif %}
                                </td>
                                <td>{{ game.move_count }}</td>
                                <td>
                                    {% if game.winner == request.user %}
                                        <span class="text-success">Won</span>
                                    {% elif game.winner %}
                                        <span class="text-danger">Lost</span>
                                    {% else %}
                                        <span class="text-warning">Draw</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if game.user_journal_entries %}
                                        {{ game.user_journal_entries.0.description }}
                                    {% else %}
                                        No Entry
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group" aria-label="Actions">
                                        <a href="{% url 'edit_journal' game.id %}" class="btn btn-primary btn-sm">Edit</a>
                                        
                                        <!-- Delete Button triggers Modal -->
                                        <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal{{ game.id }}">
                                            Delete
                                        </button>
                                        
                                        <!-- Modal Structure -->
                                        <div class="modal fade" id="deleteModal{{ game.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ game.id }}" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <form method="post" action="{% url 'delete_game' game.id %}">
                                                        {% csrf_token %}
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="deleteModalLabel{{ game.id }}">Confirm Delete</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            Are you sure you want to delete this game? This action cannot be undone.
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                            <button type="submit" class="btn btn-danger">Delete</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p>No completed games yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    <script>
        // Determine the correct WebSocket protocol
        const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const challengeSocket = new WebSocket(`${protocol}${window.location.host}/ws/challenges/`);

        challengeSocket.onopen = function () {
            console.log("WebSocket connection established.");
        };

        challengeSocket.onmessage = function (event) {
            console.log("WebSocket message received:", event.data);
            const data = JSON.parse(event.data);

            // Handle new user registration
            if (data.type === 'new_user') {
                const userId = data.user_id;
                const username = data.username;

                // Do not add if the new user is the current user
                if (userId !== currentUserId) {
                    // Check if the user already exists in the list to prevent duplicates
                    const existingUser = document.querySelector(`.user-list li[data-user-id='${userId}']`);
                    if (!existingUser) {
                        // Create a new list item
                        const userList = document.querySelector('.user-list');
                        const newUserListItem = document.createElement('li');
                        newUserListItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        newUserListItem.setAttribute('data-user-id', userId);
                        newUserListItem.innerHTML = `
                            <span>${username}</span>
                            <div>
                                <button class="btn btn-primary btn-sm challenge-btn" data-user-id="${userId}">Challenge</button>
                            </div>
                        `;
                        userList.appendChild(newUserListItem);
                        console.log(`Added new user ${username} to the challenge list.`);
                    }
                }
            }

            // If a new challenge is received
            if (data.challenger_id && data.challenger_username) {
                const userListItem = document.querySelector(`.user-list li[data-user-id='${data.challenger_id}']`);
                if (userListItem) {
                    const actionDiv = userListItem.querySelector('div');
                    actionDiv.innerHTML = `
                        <button
                            class="btn btn-success btn-sm ml-2 accept-btn"
                            data-user-id="${data.challenger_id}"
                            data-action="accept"
                        >Accept</button>
                        <button
                            class="btn btn-danger btn-sm ml-2 reject-btn"
                            data-user-id="${data.challenger_id}"
                            data-action="reject"
                        >Reject</button>
                    `;
                }
            }

            // Handle redirection for accepted challenges
            if (data.redirect) {
                window.location.href = `/play/${data.game_id}/`;
            }

            // Handle challenge rejection
            if (data.type === 'challenge_rejected') {
                const challengedId = data.challenged_id;
                const challengedUsername = data.challenged_username;

                // Update UI to remove 'Pending' status and show 'Challenge' button
                const userListItem = document.querySelector(`.user-list li[data-user-id='${challengedId}']`);
                if (userListItem) {
                    const actionDiv = userListItem.querySelector('div');
                    actionDiv.innerHTML = `
                        <button class="btn btn-primary btn-sm challenge-btn" data-user-id="${challengedId}">Challenge</button>
                    `;
                }

                // Notify the user that the challenge was declined
                alert(`${challengedUsername} has declined your challenge.`);
            }

        };

        challengeSocket.onerror = function (error) {
            console.error('WebSocket Error:', error);
        };

        challengeSocket.onclose = function (event) {
            console.log('WebSocket connection closed:', event);
        };

        // Function to handle accepting or rejecting challenges
        function handleChallenge(userId, action) {
            fetch(`/handle_challenge/${userId}/${action}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log(`${action} action successful.`);
                    const userListItem = document.querySelector(`.user-list li[data-user-id='${userId}']`);
                    if (userListItem) {
                        const actionDiv = userListItem.querySelector('div');
                        if (action === 'accept') {
                            // Redirect is handled via WebSocket
                        } else if (action === 'reject') {
                            // Reset to show the challenge button again
                            actionDiv.innerHTML = `
                                <button class="btn btn-primary btn-sm challenge-btn" data-user-id="${userId}">Challenge</button>
                            `;
                        }
                    }
                } else {
                    console.error('Error handling challenge:', data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Function to get CSRF token from cookie
        function getCSRFToken() {
            let cookieValue = null;
            const cookies = document.cookie ? document.cookie.split(';') : [];
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith('csrftoken=')) {
                    cookieValue = decodeURIComponent(cookie.substring('csrftoken='.length));
                    break;
                }
            }
            return cookieValue;
        }

        // Attach event listeners using event delegation
        document.addEventListener('DOMContentLoaded', function () {
            // Event delegation for user list actions
            const userList = document.querySelector('.user-list');
            userList.addEventListener('click', function (event) {
                const target = event.target;
                if (target.matches('.challenge-btn')) {
                    const userId = target.getAttribute('data-user-id');
                    console.log(`Challenge button clicked for user ID: ${userId}`);

                    fetch(`/send_challenge/${userId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCSRFToken(),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            console.log('Challenge sent successfully.');
                            // Update the button to show 'Pending'
                            target.parentElement.innerHTML = `<span class="badge badge-warning">Pending</span>`;
                        } else {
                            console.error('Error sending challenge:', data.error);
                            alert(`Error sending challenge: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while sending the challenge.');
                    });
                } else if (target.matches('.accept-btn, .reject-btn')) {
                    const userId = target.getAttribute('data-user-id');
                    const action = target.getAttribute('data-action');
                    handleChallenge(userId, action);
                }
            });
        });
    </script>

</body>
</html>
